<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>KATA Viewer - 形</title>

<style>
:root{
  --box-w: 86px;
  --box-h: 104px;
  --btn-h: 40px;
  --btn-fs: 12px;
  --name-fs: 12px;
      /* ② 試合枠の上下間隔*/
  --gap-y: 20px;
  --top-pad: 14px;
  --col-gap: 20px;
  --side-w: 26px;
  --side-gap: 8px;
  --final-accent:#2563eb;

  /* 決勝UI幅調整 */
  --judge-score-w:80px;
  --judge-btn-fs:13px;
  --judge-score-fs:14px;

  /* テンキー共通（ここを触ると全部変わる） */
  --key-btn-fs:16px;
  --key-btn-h:40px;
  --key-gap:8px;          /* ボタン間隔 */
  --label-gap-top:12px;   /* 「少数桁」の上余白（縦間隔） */

  --bottom-gap: 30px;
}

html,body{margin:0;padding:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:#fff;color:#111;}
    #page{padding:8px;box-sizing:border-box;max-width:520px;margin:0 auto;}

.titleBox{border:1px solid #111;padding:6px 8px;box-sizing:border-box;}
#metaTitle{
  width:100%;border:none;outline:none;font-weight:900;font-size:20px;line-height:1.2;
  background:transparent;padding:0;margin:0;
}

#topGrid{
  display:grid;
  grid-template-columns: 0.95fr 1.05fr; /* 縦でも左右2列固定 */
  gap:12px;
  align-items:start;
  margin-top:8px;
}
.card{border:none;padding:0;box-sizing:border-box;}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.row + .row{margin-top:10px;}

#courtPalette{
  display:grid;
  grid-template-columns:repeat(4,46px);
  gap:8px;
  align-items:center;
}
.court-input{
  width:46px;height:46px;text-align:center;font-size:16px;box-sizing:border-box;background:#fff;
  border:4px solid #ddd;border-radius:6px;
}
.court-input.selected{outline:4px solid var(--final-accent);outline-offset:2px;}

input[type="number"], input[type="text"]{
  border:1px solid #777;border-radius:8px;padding:8px 5px;font-size:15px;box-sizing:border-box;
}
#courtCountInput{width:66px;text-align:center;}
#metaType,#metaStyle{width:85px;text-align:center;}
#metaCategory{width:190px;}

button{
  font-size:15px;padding:9px 14px;border:1px solid #777;border-radius:12px;background:#e9e9e9;
}
button:disabled{opacity:.45;}
button.armed{background:#cce5ff;border:2px solid #3399ff;}

#players{
  width:100%;
  min-height:260px;
  font-size:15px;
  padding:12px 5px;
  box-sizing:border-box;
  border:1px solid #111;
  resize:vertical;
}

/* ===== トーナメント ===== */
.wrapper{
  position:relative;
  width:100%;
  height:520px;
  overflow:auto;
  border:1px solid #111;
  background:#fff;
  margin-top:10px;
}
#tournament{
  position:relative;
  display:inline-flex;
  align-items:flex-start;
  white-space:nowrap;
  padding: 14px 16px 18px 10px;
  box-sizing:border-box;
  min-height:320px;
}
#lines{position:absolute;inset:0;pointer-events:none;}

.side-column{
  position:relative;
  width:var(--side-w);
  min-width:var(--side-w);
  margin-right:var(--side-gap);
}
.side-row{
  position:absolute;left:0;width:100%;
  display:flex;justify-content:flex-start;
  padding-left:1px;box-sizing:border-box;
}
.side-btn{
  width:30px;
  height:35px;
  padding:0;
  font-size:12px;
  border-radius:4px;
  border:1px solid #777;
  background:#efefef;
  pointer-events:auto;
}

.column{
  position:relative;
  width:calc(var(--box-w) + 20px);
  min-width:calc(var(--box-w) + 20px);
  overflow:visible;
  margin-right:var(--col-gap);
}
.match-wrapper{position:absolute;width:auto;height:var(--box-h);overflow:visible;}
.match{
  width:var(--box-w);
  border:1px solid #111;
  padding:4px;
  box-sizing:border-box;
  border-radius:6px;
  background:#fff;
}

.playerBtn{
  display:block;
  width:100%;
  height:var(--btn-h);
  margin:2px 0;
  font-size:var(--btn-fs);
  line-height:1.05;
  padding:2px 6px;
  text-align:center;
  box-sizing:border-box;
  white-space:normal;
  word-break:break-word;
  border:1px solid #777;
  border-radius:6px;
  background:#fff;
}
.playerBtn .ln,.playerBtn .fn{display:block;font-size:var(--name-fs);}
button.selected{background:#cce5ff;border:2px solid #3399ff;}
button.winner{background:#99edf8;border:2px solid #3374ff;font-weight:900;}
button.loser{opacity:.45;pointer-events:none;}
button.seed{color:#999!important;opacity:.35;cursor:not-allowed;background:#f2f2f2;}
.playerBtn.absent{opacity:.35;cursor:not-allowed;}
.playerBtn.withdraw{opacity:.55;text-decoration:line-through;cursor:not-allowed;}

/* ===== 決勝 ===== */
#finalBtnBar{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;}
#finalArea{border:1px solid #111;padding:10px;box-sizing:border-box;margin-top:10px;}
#finalArea.hidden{display:none;}
#finalHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
#finalHeader b{font-size:18px;}
#judgeCount,#basePoint{width:64px;text-align:center;}

.panel{border:1px solid #111;padding:8px;box-sizing:border-box;}
#finalGrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}

#finalPlayersTable{width:100%;border-collapse:collapse;font-size:13px;}
#finalPlayersTable th,#finalPlayersTable td{border:1px solid #111;padding:6px 6px;text-align:center;white-space:nowrap;}
#finalPlayersTable th:first-child,#finalPlayersTable td:first-child{text-align:left;white-space:normal;}
.finalRowBtn{width:100%;text-align:left;border:none;background:transparent;font-size:13px;padding:0;}
.trSelected{outline:2px solid var(--final-accent);outline-offset:-2px;}
.trSelected td{background:#e7f0ff;}
.scoreCell{font-weight:900;}
.miniCell{font-size:12px;opacity:.85;}
.manualTag{font-size:11px;padding-left:4px;opacity:.85;font-weight:900;}
#finalHint{margin-top:8px;font-size:12px;opacity:.85;}

/* 左=審判+点、右=テンキー類 */
#judgeKeyGrid{
  display:grid;
  grid-template-columns: 1fr 1.1fr;
  gap:10px;
  align-items:start;
}
#judgeList{display:flex;flex-direction:column;gap:6px;}
.jRow{display:grid;grid-template-columns: 1fr var(--judge-score-w);gap:6px;align-items:center;}
.jBtn{
  padding:8px 8px;border-radius:10px;background:#fff;border:1px solid #111;text-align:left;
  font-size:var(--judge-btn-fs);
}
.jScore{
  border:1px solid #111;border-radius:10px;padding:8px 6px;font-weight:900;text-align:center;background:#fff;
  font-size:var(--judge-score-fs);
}
.jActive .jBtn,.jActive .jScore{
  outline:3px solid var(--final-accent);
  outline-offset:1px;
  background:#e7f0ff;
}

/* ===== テンキー（依頼①②） ===== */
.kLabel{font-weight:900;}
#intMain{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:var(--key-gap);
}
#decPad{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:var(--key-gap);
}
#decBottomRow{
  display:grid;
  grid-template-columns: 1fr 1fr; /* [0] [次] を同じ行に */
  gap:var(--key-gap);
  margin-top:var(--key-gap);
}
#intSub{
  display:grid;
  grid-template-columns:repeat(2,1fr); /* [5][9] */
  gap:var(--key-gap);
}

.kBtn{
  width:100%;
  height:var(--key-btn-h);
  padding:0;
  border:1px solid #111;
  border-radius:12px;
  background:#fff;
  font-size:var(--key-btn-fs);
  font-weight:900;
  box-sizing:border-box;
}
.kBtn.active{
  outline:3px solid var(--final-accent);
  outline-offset:1px;
  background:#e7f0ff;
}
#nextBtn{
  background:#fff;
  border:1px solid #111;   /* 他と同じ太さ */
  border-radius:12px;      /* 他と同じ */
  font-weight:900;
}

/* 順位表 */
#rankCard{border:1px solid #111;padding:8px;box-sizing:border-box;margin-top:10px;}
#rankCardTitle{font-weight:900;margin-bottom:6px;}
#rankAll{font-size:13px;font-weight:900;}
#rankAll div.seed-rank{color:#bbb!important;opacity:.25!important;font-weight:normal!important;}

/* 再試合（必要時に表示） */
#tbArea{border:1px solid #111;padding:8px;box-sizing:border-box;margin-top:10px;}
#tbHeadRow{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
#tbTitle{font-weight:900;}
#tbCards.hidden{display:none;}
.tbCard{border:1px solid #111;border-radius:12px;padding:8px;box-sizing:border-box;margin-top:8px;}
.tbHead{display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap;}
.tbHead b{font-size:14px;}
.tbRow{display:grid;grid-template-columns:1fr 90px;gap:8px;margin-top:6px;align-items:center;}
.tbRow select,.tbRow input{
  width:100%;border:1px solid #777;border-radius:10px;padding:10px 10px;font-size:14px;box-sizing:border-box;
}
.tbBtns{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
.tbBtns button{padding:9px 12px;border-radius:12px;}
.tbOrder{margin-top:8px;display:grid;grid-template-columns:1fr;gap:6px;}
.tbOrder select{
  width:100%;border:1px solid #777;border-radius:10px;padding:10px;font-size:14px;box-sizing:border-box;
}
.smallNote{font-size:12px;opacity:.85;margin-top:6px;}

    select{
      border:1px solid #777;
      border-radius:8px;
      padding:8px 5px;
      font-size:15px;
      box-sizing:border-box;
      background:#fff;
    }
    #catSelect{width:190px;max-width:100%;}
    #lastSync{min-width:120px;}



/* ===== viewer 最小表示（kata） ===== */
.viewerHeader{text-align:center; margin:8px 0 10px;}
.viewerTitle{font-size:18px; font-weight:900; line-height:1.3;}
.viewerMeta{margin-top:6px; font-size:13px; font-weight:800;}
.viewerMeta span{margin:0 6px;}
body.viewer-mode { margin:8px; }
body.viewer-mode #page{ padding:0; }
body.viewer-mode .titleBox{ display:none !important; }
body.viewer-mode #viewerHeader{ display:block !important; }
body.viewer-mode #topGrid{ display:none !important; }
body.viewer-mode .wrapper{ border:none !important; background:transparent !important; margin-top:6px !important; }
body.viewer-mode input, 
body.viewer-mode textarea, 
body.viewer-mode select{ display:none !important; }

/* 編集用ボタン類のみ非表示（トーナメント内のボタンは残す） */
body.viewer-mode #topGrid button,
body.viewer-mode #finalBtnBar,
body.viewer-mode #finalBtnBar button,
body.viewer-mode #setCourtCountBtn,
body.viewer-mode #saveServerBtn,
body.viewer-mode #loadServerBtn,
body.viewer-mode #tempSaveBtn,
body.viewer-mode #finalSaveBtn,
body.viewer-mode #downloadJsonBtn,
body.viewer-mode #uploadJsonBtn,
body.viewer-mode #clearBtn,
body.viewer-mode #resetBtn{ display:none !important; }

/* ===== viewer表示をはっきり黒にする ===== */
body.viewer-mode .playerBtn,
body.viewer-mode .player,
body.viewer-mode .name,
body.viewer-mode .match,
body.viewer-mode .matchBox,
body.viewer-mode .slot,
body.viewer-mode .winner {
  color: #000 !important;
  border-color: #000 !important;
  background: #fff !important;
  opacity: 1 !important;
}

/* viewer用：一覧へ戻るボタン */
.backIndex{
  position: fixed;
  top: 6px;
  right: 6px;
  z-index: 9999;

  font-size: 12px;
  padding: 4px 8px;
  background: rgba(0,0,0,.55);
  color: #fff;
  border-radius: 999px;
  text-decoration: none;
  line-height: 1;
}

/* ===== viewer専用：操作できないようにロック ===== */
body.viewer-mode .side-btn,
body.viewer-mode #tournament button,
body.viewer-mode #courtPalette button,
body.viewer-mode .match-wrapper,
body.viewer-mode .matchBox{
  pointer-events: none !important;
  cursor: default !important;
}



</style>
</head>

<body>
<div id="page">
  <div class="titleBox">
    <input id="metaTitle" type="text" value="第00回 神奈川県空手道選手権大会" />
  </div>
    <!-- viewer用：indexに戻る -->
    <a href="./index.html" class="backIndex">一覧へ</a>
  <div id="viewerHeader" class="viewerHeader" style="display:none;">
    <div id="viewerTitle" class="viewerTitle"></div>
    <div class="viewerMeta">
      <span id="viewerCourt"></span>
      <span id="viewerCategory"></span>
    </div>
  </div>


  <div id="topGrid">
    <div class="card">
      <div class="row">
        <div style="font-weight:900;font-size:16px;">コート：</div>
        <div id="courtPalette"></div>
      </div>

      <div class="row">
        <input id="courtCountInput" type="number" min="1" max="8" value="1">
        <div style="font-weight:900;">コート数
        <button id="setCourtCountBtn" type="button">表示</button></div>
      </div>

      <div class="row">
        <input id="metaStyle" type="text" value="個人戦">
        <div style="font-weight:900;">/</div>
        <input id="metaType" type="text" value="形">
      </div>

      <div class="row">
        <input id="metaCategory" type="text" value="一般男子の部">
      </div>

      <!--
      <div class="row" id="catRow">
        <select id="catSelect"></select>
      </div>
      -->

      <div class="row" id="syncRow">
        <input id="whoInput" type="text" placeholder="更新者(任意)" style="width:120px;" />
        <button id="srvLoadBtn" type="button">サーバー読込</button>
        <button id="srvSaveBtn" type="button">サーバー保存</button>
      </div>

      <div class="row" id="viewerRow" style="display:none;align-items:center;gap:10px;flex-wrap:wrap;">
        <button id="refreshBtn" type="button">更新</button>
        <label style="display:flex;align-items:center;gap:6px;font-weight:900;font-size:13px;">
          <input id="autoRefreshToggle" type="checkbox" />自動更新
        </label>
        <input id="autoRefreshSec" type="number" min="10" max="600" value="90" style="width:70px;text-align:center;" />
        <div id="lastSync" style="font-size:12px;opacity:.85;"></div>
      </div>


      <div class="row">
        <button id="startBtn" type="button">開始</button>
        <button id="saveBtn" type="button">一時保存</button>
        <button id="loadBtn" type="button">受信JSON読込</button>
        <input id="loadFile" type="file" accept="application/json,.json" style="display:none" />
      </div>
    </div>

    <div class="card">
      <textarea id="players" placeholder="選手登録欄
苗字と名の間は全角スペース
例）神奈川　県太郎 / 1行1名"></textarea>
    </div>
  </div>

  <div class="wrapper" id="wrapper">
    <svg id="lines"></svg>
    <div id="tournament"></div>
  </div>

  <div id="finalBtnBar">
    <button id="finalBtn" type="button">決勝</button>
  </div>

  <div id="finalArea" class="hidden">
    <div id="finalHeader">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <b>決勝戦（採点）</b>
        <span style="font-weight:900;">審判</span>
        <input type="number" id="judgeCount" min="3" max="9" value="7">
        <span style="font-weight:900;">基準点</span>
        <input type="number" id="basePoint" min="0" max="9" value="7">
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button id="finalSaveBtn" type="button">保存</button>
        <button id="finalCloseBtn" type="button">閉じる</button>
      </div>
    </div>

    <div id="finalGrid">
      <div class="panel">
        <table id="finalPlayersTable" aria-label="決勝 選手一覧">
          <thead>
            <tr>
              <th>選手（8名）</th>
              <th class="scoreCell">合計</th>
              <th class="miniCell">+最小</th>
              <th class="miniCell">+最大</th>
            </tr>
          </thead>
          <tbody id="finalPlayersTbody"></tbody>
        </table>
        <div id="finalHint">合計セルをタップで手入力（常に手入力優先）／選手→審判→キー入力→「次」</div>
      </div>

      <div class="panel">
        <div id="judgeKeyGrid">
          <div id="judgeList"></div>

          <div>
            <div class="kLabel">一の位</div>
            <div id="intMain" style="margin-top:8px;"></div>

            <div class="kLabel" style="margin-top:var(--label-gap-top);">少数桁</div>
            <div id="decPad" style="margin-top:8px;"></div>

            <div id="decBottomRow"></div>

            <div style="margin-top:12px;">
              <div class="kLabel">一の位予備</div>
              <div id="intSub" style="margin-top:8px;"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="rankCard">
        <div id="rankCardTitle">順位表</div>
        <div id="rankAll">
          <div id="rank1">1位：--</div>
          <div id="rank2">2位：--</div>
          <div id="rank3">3位：--</div>
          <div id="rank4">4位：--</div>
          <div id="rank5">5位：--</div>
          <div id="rank6">6位：--</div>
          <div id="rank7">7位：--</div>
          <div id="rank8">8位：--</div>
        </div>
      </div>

      <div id="tbArea">
        <div id="tbHeadRow">
          <div id="tbTitle">再試合（タイブレーク）</div>
          <button id="tbToggleBtn" type="button">表示</button>
        </div>
        <div class="smallNote">必要時のみ表示。最大4試合。点順は補助（最終は手動確定）。反映は対象順位から最大4枠。</div>
        <div id="tbCards" class="hidden"></div>
      </div>

    </div>
  </div>

</div>

<script>
// viewer-mode判定（最小表示）
(() => {
  const params = new URLSearchParams(location.search);
  /* viewer専用 */

  document.body.classList.add("viewer-mode");

  // タイトル（編集側inputの値を表示）
  const titleInput = document.getElementById("metaTitle");
  const title = titleInput ? (titleInput.value || "").trim() : "";
  const titleEl = document.getElementById("viewerTitle");
  if (titleEl) titleEl.textContent = title || "第00回 神奈川県空手道選手権大会";

  // コート（URL ?court=1 など。無ければ 1）
  const court = (params.get("court") || "1").trim();
  const courtEl = document.getElementById("viewerCourt");
  if (courtEl) courtEl.textContent = `閲覧専用　コート[ ${court} ]`;

  // カテゴリー（URL ?cat=...）
  const cat = (params.get("cat") || "").trim();

  const CAT_LABELS = {
    // 団体
    "team_e34_m":"小学３・４年男子の部",
    "team_e34_f":"小学３・４年女子の部",
    "team_e56_m":"小学５・６年男子の部",
    "team_e56_f":"小学５・６年女子の部",
    "team_jhs_m":"中学生男子の部",
    "team_jhs_f":"中学生女子の部",
    "team_hs_m":"高校生男子の部",
    "team_hs_f":"高校生女子の部",
    "team_adult_m":"一般男子の部",
    "team_adult_f":"一般女子の部",
    // 個人
    "ind_e3_m":"小学３年男子の部",
    "ind_e3_f":"小学３年女子の部",
    "ind_e4_m":"小学４年男子の部",
    "ind_e4_f":"小学４年女子の部",
    "ind_e5_m":"小学５年男子の部",
    "ind_e5_f":"小学５年女子の部",
    "ind_e6_m":"小学６年男子の部",
    "ind_e6_f":"小学６年女子の部",
    "ind_j1_m":"中学１年男子の部",
    "ind_j1_f":"中学１年女子の部",
    "ind_j2_m":"中学２年男子の部",
    "ind_j2_f":"中学２年女子の部",
    "ind_j3_m":"中学３年男子の部",
    "ind_j3_f":"中学３年女子の部",
    "ind_hs_m":"高校生男子の部",
    "ind_hs_f":"高校生女子の部",
    "ind_adult_m":"一般男子の部",
    "ind_adult_f":"一般女子の部"
  };

  const group = cat.startsWith("team_") ? "団体戦" : (cat.startsWith("ind_") ? "個人戦" : "カテゴリー");
  const label = CAT_LABELS[cat] || (cat ? cat : "未指定");
  const catEl = document.getElementById("viewerCategory");
  if (catEl) catEl.textContent = `${group} 形 ${label}`; /*カテゴリー：*/
})();


let courtList = ["-"];
const courtColors = [
  { bg: "#fafafa", border: "#dddddd" },
  { bg: "#e0f0ff", border: "#9ec5ff" },
  { bg: "#e6ffe6", border: "#9ee6b0" },
  { bg: "#fff2e0", border: "#f5c79a" },
  { bg: "#f0e6ff", border: "#c9a8f7" },
  { bg: "#ffe0f0", border: "#f3a8c9" },
  { bg: "#e0fff7", border: "#9ee6d5" },
  { bg: "#f7ffe0", border: "#c9e69a" }
];
let selectedCourt = null;

let state = { players:[], rounds:[], best8:[], metaTitle:"", metaType:"", metaStyle:"", metaCategory:"", finalState:null };

const LONG_PRESS_TIME = 600;
let pendingWin = null;

let finalPlayers = [];
let finalScoresByPlayer = [];
let finalManualTotal = [];
let finalSelectedPlayer = 0;
let finalSelectedJudge = 0;
let judgeNum = 7;
let curInt = null;
let curDec = null;

let rankOverride = Array(8).fill(null);
let tiebreaks = [];

function getCssNum(name, fallback){
  const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  if(!v) return fallback;
  const n = Number(String(v).replace("px",""));
  return Number.isFinite(n) ? n : fallback;
}
function splitName(name){
  const n = (name || "").trim();
  if(!n) return ["—",""];
  if(n === "seed") return ["seed",""];
  const parts = n.split(/　+/);
  if(parts.length >= 2) return [parts[0], parts.slice(1).join("　")];
  return [n,""];
}
function isSeed(p){ return p && p.name === "seed"; }
function isAbsent(p){ return p && p.attendance === "欠"; }
function isWithdraw(p){ return p && p.attendance === "棄"; }
function clearSelection(){
  document.querySelectorAll(".selected").forEach(b=>b.classList.remove("selected"));
  pendingWin = null;
}

/* ===== コート ===== */
function buildCourtPalette(){
  const area = document.getElementById("courtPalette");
  area.innerHTML = "";
  courtList.forEach((nameToggle, i) => {
    const inp = document.createElement("input");
    inp.className = "court-input";
    inp.dataset.index = i;
    if(!nameToggle){ courtList[i] = "-"; nameToggle = "-"; }
    inp.value = nameToggle;

    const c = courtColors[i % courtColors.length];
    inp.style.border = "4px solid " + c.border;

    const setSelected = () => {
      selectedCourt = (inp.value.trim() || "-");
      document.querySelectorAll(".court-input").forEach(x=>x.classList.remove("selected"));
      inp.classList.add("selected");
    };
    inp.addEventListener("focus", setSelected);
    inp.addEventListener("click", setSelected);
    inp.addEventListener("input", () => {
      courtList[i] = inp.value.trim() || "-";
      selectedCourt = courtList[i];
    });
    area.appendChild(inp);
  });

  const first = area.querySelector(".court-input");
  if(first){
    first.classList.add("selected");
    selectedCourt = first.value.trim() || "-";
  }else{
    selectedCourt = "-";
  }
}
function applyCourtCount(){
  const count = Math.max(1, Math.min(8, Number(document.getElementById("courtCountInput").value || 1)));
  courtList = Array(count).fill("-");
  buildCourtPalette();
}
document.getElementById("setCourtCountBtn").addEventListener("click", applyCourtCount);

/* ===== トーナメント（ベスト8まで） ===== */
function decideBracketSize(n){
  if(n <= 8) return 8;
  if(n <= 16) return 16;
  if(n <= 32) return 32;
  if(n <= 64) return 64;
  if(n <= 128) return 128;
  return 256;
}
function roundsCountToBest8(startSize){
  // 8人: 1回戦(4試合)
  // 16人: 2回戦まで(8試合→4試合)
  // 32人: 3回戦まで(16→8→4試合)
  // 64人: 4回戦まで(32→16→8→4試合)
  const log2 = Math.log2(startSize);
  return Math.max(1, log2 - 2);
}

function buildRoundsToBest8(){
  state.rounds = [];
  state.best8 = [];

  const n = state.players.length;
  const startSize = decideBracketSize(n);
  const roundsToShow = roundsCountToBest8(startSize);

  // 1回戦：不足分は seed で埋める（seed は押せない）
  const list = state.players.slice();
  while(list.length < startSize) list.push({name:"seed", attendance:"-"});

  // Round 0（1回戦）
  const r0 = [];
  for(let i=0;i<startSize;i+=2){
    r0.push({ players:[list[i], list[i+1]], winner:null, court:null });
  }
  state.rounds.push(r0);

  // Round 1以降：前ラウンドに紐づく分だけ作る（余分は作らない）
  for(let r=1;r<roundsToShow;r++){
    const prevMatches = state.rounds[r-1].length;  // 例) 16人: 8試合
    const matchCount = Math.floor(prevMatches / 2); // 次は 4試合
    const rr = [];
    for(let m=0;m<matchCount;m++){
      rr.push({ players:[null, null], winner:null, court:null });
    }
    state.rounds.push(rr);
  }

  // seed / "-" のみ自動勝者
  state.rounds.forEach((round, r)=>round.forEach((_, m)=>autoJudgeMatch(r,m)));
}


function calcY(r, m){
  const BOX_H = getCssNum("--box-h", 104);
  const GAP = getCssNum("--gap-y", 26);
  if(r===0) return m*(BOX_H+GAP);
  const p=m*2;
  return (calcY(r-1,p)+calcY(r-1,p+1))/2;
}

/* 出欠列 */
function createSideButton(player, parent){
  // viewerでは出欠操作（長押し含む）を完全に無効化
  if(document.body.classList.contains("viewer-mode")){
    const btn = document.createElement("button");
    btn.className = "side-btn";
    btn.textContent = (player && player.attendance) ? player.attendance : "-";
    btn.disabled = true;
    parent.appendChild(btn);
    return;
  }

  const btn = document.createElement("button");
  btn.className = "side-btn";
  const states = ["-","済","未","欠","棄"];
  let idx = states.indexOf(player.attendance || "-");
  if(idx<0) idx=0;
  btn.textContent = states[idx];

  let timer = null;
  btn.onmousedown = btn.ontouchstart = (e) => {
    e.preventDefault();
    timer = setTimeout(()=>{
      idx = (idx+1) % states.length;
      btn.textContent = states[idx];
      player.attendance = states[idx];
      state.rounds.forEach((round, r)=>round.forEach((_, m)=>autoJudgeMatch(r,m)));
      renderBase();
      render();
    }, LONG_PRESS_TIME);
  };
  btn.onmouseup = btn.onmouseleave = btn.ontouchend = () => {
    if(timer){ clearTimeout(timer); timer=null; }
  };
  parent.appendChild(btn);
}

function renderBase(){
  const t = document.getElementById("tournament");
  const l = document.getElementById("lines");
  t.innerHTML = "";
  l.innerHTML = "";

  let maxY = 0;

  const sideCol = document.createElement("div");
  sideCol.className = "side-column";
  t.appendChild(sideCol);

  state.rounds.forEach((round, r)=>{
    const col = document.createElement("div");
    col.className = "column";

    round.forEach((match, m)=>{
      const w = document.createElement("div");
      w.className = "match-wrapper";
      w.id = `r${r}m${m}`;
      w.style.top = (calcY(r, m) + getCssNum("--top-pad", 14)) + "px";

      const box = document.createElement("div");
      box.className = "match matchBox";
      box.dataset.court = (match.court || "-");
      w.appendChild(box);

      let pressTimer = null;
      const armCourt = () => {
        if(selectedCourt != null && selectedCourt !== "-"){
          match.court = selectedCourt;
          box.dataset.court = selectedCourt;
          render();
          requestAnimationFrame(syncSidePositions);
        }
      };
      w.addEventListener("mousedown", (e)=>{
        if(e.target && e.target.tagName === "BUTTON") return;
        pressTimer = setTimeout(armCourt, LONG_PRESS_TIME);
      });
      w.addEventListener("mouseup", ()=>{ if(pressTimer) clearTimeout(pressTimer); });
      w.addEventListener("mouseleave", ()=>{ if(pressTimer) clearTimeout(pressTimer); });
      w.addEventListener("touchstart", (e)=>{
        if(e.target && e.target.tagName === "BUTTON") return;
        pressTimer = setTimeout(armCourt, LONG_PRESS_TIME);
      }, {passive:true});
      w.addEventListener("touchend", ()=>{ if(pressTimer) clearTimeout(pressTimer); });

      col.appendChild(w);
      maxY = Math.max(maxY, (calcY(r,m) + getCssNum("--top-pad",14) + getCssNum("--box-h",104)));
    });

    t.appendChild(col);
  });

  const h = Math.max(320, maxY + 40);
  t.style.height = h + "px";
  t.style.minHeight = h + "px";
  t.querySelectorAll(".column").forEach(col => col.style.height = h + "px");
  t.querySelectorAll(".side-column").forEach(col => col.style.height = h + "px");

  // 縦スクロールの下限を「最下段match下端」で固定するためのスペーサ
  let spacer = document.getElementById("vSpacer");
  if(!spacer){
    spacer = document.createElement("div");
    spacer.id = "vSpacer";
    spacer.style.width = "1px";
    spacer.style.height = "1px";
  }
  t.appendChild(spacer);


  buildSideRows();
  requestAnimationFrame(syncSidePositions);
}

function buildSideRows(){
  const sideCol = document.querySelector("#tournament .side-column");
  if(!sideCol) return;
  sideCol.innerHTML = "";
  if(!state.rounds[0]) return;

  state.rounds[0].forEach((match, m)=>{
    const r1 = document.createElement("div");
    r1.className = "side-row";
    r1.dataset.slot = `m${m}s0`;
    createSideButton(match.players[0], r1);
    sideCol.appendChild(r1);

    const r2 = document.createElement("div");
    r2.className = "side-row";
    r2.dataset.slot = `m${m}s1`;
    createSideButton(match.players[1], r2);
    sideCol.appendChild(r2);
  });
}

function syncSidePositions(){
  const t = document.getElementById("tournament");
  const sideCol = t.querySelector(".side-column");
  if(!sideCol || !state.rounds[0]) return;

  // トーナメント側のレイアウト値（CSSと一致させる）
  const TOP_PAD = getCssNum("--top-pad", 14);
  const BTN_H   = getCssNum("--btn-h", 40);

  // CSSの .match と .playerBtn に合わせる
  const MATCH_PADDING_TOP = 4; // .match{ padding:4px; } の上
  const BTN_MARGIN_TOP    = 3; // .playerBtn{ margin:3px 0; } の上
  const BTN_MARGIN_BOTTOM = 3; // .playerBtn{ margin:3px 0; } の下

  // 1つ目の選手ボタンのtop（match wrapper内の基準）
  const firstBtnTopOffset = MATCH_PADDING_TOP + BTN_MARGIN_TOP;

  // 2つ目の選手ボタンのtop（1つ目の高さ＋margin下＋次のmargin上）
  const secondBtnTopOffset = firstBtnTopOffset + BTN_H + (BTN_MARGIN_BOTTOM + BTN_MARGIN_TOP);

  state.rounds[0].forEach((match, m)=>{
    const wrapTop = calcY(0, m) + TOP_PAD; // match-wrapper の top と同じ基準

    const r1 = sideCol.querySelector(`.side-row[data-slot="m${m}s0"]`);
    const r2 = sideCol.querySelector(`.side-row[data-slot="m${m}s1"]`);

    if(r1) r1.style.top = (wrapTop + firstBtnTopOffset) + "px";
    if(r2) r2.style.top = (wrapTop + secondBtnTopOffset) + "px";
  });
}

function selectWinner(r, m, p, btn){
  if(!p) return;
  if(isSeed(p) || isAbsent(p) || isWithdraw(p)) return;
  const match = state.rounds[r][m];
  if(match.winner) return;

  if(pendingWin && pendingWin.r===r && pendingWin.m===m && pendingWin.p===p){
    clearSelection();
    win(r,m,p);
    return;
  }
  clearSelection();
  pendingWin = {r,m,p};
  btn.classList.add("selected");
}
function win(r, m, w){
  const match = state.rounds[r][m];
  if(match.winner) return;
  match.winner = w;

  if(r < state.rounds.length - 1){
    const next = state.rounds[r+1][Math.floor(m/2)];
    const slot = m % 2;
    if(!Array.isArray(next.players)) next.players = [null,null];
    next.players[slot] = w;
    autoJudgeMatch(r+1, Math.floor(m/2));
  }
  render();
}
function undo(r, m){
  const match = state.rounds[r][m];
  if(!match.winner) return;
  if(isSeed(match.winner)) return;

  if(r < state.rounds.length - 1){
    const next = state.rounds[r+1][Math.floor(m/2)];
    if(next && next.winner) return;
    const slot = m % 2;
    if(next && Array.isArray(next.players)) next.players[slot] = null;
  }
  match.winner = null;
  render();
}

/* 自動勝者：seed / '-' のみ（欠/棄は自動勝者にしない） */
function autoJudgeMatch(r, m){
  if(!state.rounds[r] || !state.rounds[r][m]) return;
  const match = state.rounds[r][m];
  if(match.winner) return;

  const p1 = match.players[0];
  const p2 = match.players[1];
  if(!p1 && !p2) return;

  const p1Seed = isSeed(p1) || (p1 && p1.name === "-");
  const p2Seed = isSeed(p2) || (p2 && p2.name === "-");

  if(p1Seed && !p2Seed && p2){ win(r,m,p2); return; }
  if(p2Seed && !p1Seed && p1){ win(r,m,p1); return; }
}

function render(){
  state.rounds.forEach((round, r)=>{
    round.forEach((match, m)=>{
      const wrap = document.getElementById(`r${r}m${m}`);
      if(!wrap) return;
      const box = wrap.querySelector(".match");
      box.innerHTML = "";

      box.style.border = "1px solid #111";
      box.dataset.court = (match.court || "-");
      if(match.court != null && match.court !== "-"){
        const idx = courtList.indexOf(match.court);
        if(idx >= 0){
          const c = courtColors[idx % courtColors.length];
          box.style.border = "5px solid " + c.border;
        }
      }

      match.players.forEach((p)=>{
        const b = document.createElement("button");
        b.className = "playerBtn";

        if(!p){
          b.textContent = "—";
          b.disabled = true;
          b.classList.add("seed");
          box.appendChild(b);
          return;
        }
        if(p.name === "-"){
          b.textContent = "-";
          b.disabled = true;
          b.classList.add("seed");
          box.appendChild(b);
          return;
        }

        if(isSeed(p)){ b.disabled = true; b.classList.add("seed"); }
        if(isAbsent(p)){ b.disabled = true; b.classList.add("absent"); }
        if(isWithdraw(p)){ b.disabled = true; b.classList.add("withdraw"); }

        const parts = splitName(p.name);
        const ln = document.createElement("span"); ln.className="ln"; ln.textContent=parts[0];
        const fn = document.createElement("span"); fn.className="fn"; fn.textContent=parts[1];
        b.appendChild(ln); b.appendChild(fn);

        if(match.winner){
          if(match.winner === p) b.classList.add("winner");
          else b.classList.add("loser");
        }

        b.onclick = () => {
          if(b._longPress){ b._longPress = false; return; }
          selectWinner(r,m,p,b);
        };

        let timer = null;
        b.onmousedown = b.ontouchstart = () => {
          if(match.winner !== p) return;
          timer = setTimeout(()=>{
            b._longPress = true;
            undo(r,m);
          }, LONG_PRESS_TIME);
        };
        b.onmouseup = b.onmouseleave = b.ontouchend = () => { if(timer) clearTimeout(timer); };

        box.appendChild(b);
      });
    });
  });

    // 縦スクロールの下限（最下段match下端）を更新
  const tour = document.getElementById("tournament");
  const spacer = document.getElementById("vSpacer");
  if(tour && spacer){
    let maxBottom = 0;
    tour.querySelectorAll(".match-wrapper").forEach(el=>{
      const b = el.offsetTop + el.offsetHeight;
      if(b > maxBottom) maxBottom = b;
    });
    const bottomGap = getCssNum("--bottom-gap", 100);
    spacer.style.height = (maxBottom + bottomGap + 20) + "px";
  }


  drawLines();
  requestAnimationFrame(syncSidePositions);
}

/* 線 */
function addLine(x1,y1,x2,y2,stroke,width){
  const svg = document.getElementById("lines");
  const ln = document.createElementNS("http://www.w3.org/2000/svg","line");
  ln.setAttribute("x1", x1); ln.setAttribute("y1", y1);
  ln.setAttribute("x2", x2); ln.setAttribute("y2", y2);
  ln.setAttribute("stroke", stroke);
  ln.setAttribute("stroke-width", width);
  ln.setAttribute("stroke-linecap", "square");
  svg.appendChild(ln);
}
function drawLines(){
  const svg = document.getElementById("lines");
  const base = document.getElementById("tournament");
  svg.innerHTML = "";

  if(!state.rounds.length) return;
  if(state.rounds.length === 1) return;

  svg.setAttribute("width", base.scrollWidth);
  svg.setAttribute("height", base.scrollHeight);

  const baseRect = base.getBoundingClientRect();
  const getRect = (el) => {
    const r = el.getBoundingClientRect();
    return { left:r.left-baseRect.left, right:r.right-baseRect.left, midY:(r.top+r.height/2)-baseRect.top };
  };

  state.rounds.forEach((round, r)=>{
    if(r === state.rounds.length-1) return;
    round.forEach((match, m)=>{
      const aWrap = document.getElementById(`r${r}m${m}`);
      const bWrap = document.getElementById(`r${r+1}m${Math.floor(m/2)}`);
      if(!aWrap || !bWrap) return;

      const aBtns = aWrap.querySelectorAll(".match button");
      const bBtns = bWrap.querySelectorAll(".match button");
      if(aBtns.length < 2 || bBtns.length < 2) return;

      const a0 = getRect(aBtns[0]);
      const a1 = getRect(aBtns[1]);
      const bSlot = getRect(bBtns[m%2]);

      const xStart0 = a0.right, y0 = a0.midY;
      const xStart1 = a1.right, y1 = a1.midY;
      const xEnd = bSlot.left, yEnd = bSlot.midY;
      const xMid = (xStart0 + xEnd) / 2;
      const yMid = (y0 + y1) / 2;

      const winnerIndex = match.winner ? (match.players[0]===match.winner ? 0 : (match.players[1]===match.winner ? 1 : -1)) : -1;

      addLine(xStart0, y0, xMid, y0, "#bdbdbd", 1.2);
      addLine(xStart1, y1, xMid, y1, "#bdbdbd", 1.2);
      addLine(xMid, y0, xMid, y1, "#bdbdbd", 1.2);
      addLine(xMid, yMid, xMid, yEnd, "#bdbdbd", 1.2);
      addLine(xMid, yEnd, xEnd, yEnd, "#bdbdbd", 1.2);

      if(winnerIndex === 0){
        addLine(xStart0, y0, xMid, y0, "red", 2);
        addLine(xMid, y0, xMid, yEnd, "red", 2);
        addLine(xMid, yEnd, xEnd, yEnd, "red", 2);
      }else if(winnerIndex === 1){
        addLine(xStart1, y1, xMid, y1, "red", 2);
        addLine(xMid, y1, xMid, yEnd, "red", 2);
        addLine(xMid, yEnd, xEnd, yEnd, "red", 2);
      }
    });
  });
}

document.getElementById("wrapper").addEventListener("scroll", ()=>{
  drawLines();
  requestAnimationFrame(syncSidePositions);
});
window.addEventListener("resize", ()=>{
  drawLines();
  requestAnimationFrame(syncSidePositions);
});

/* ===== 開始 ===== */
function startTournament(){
  state.metaTitle = document.getElementById("metaTitle").value.trim();
  state.metaType = document.getElementById("metaType").value.trim();
  state.metaStyle = document.getElementById("metaStyle").value.trim();
  state.metaCategory = document.getElementById("metaCategory").value.trim();
  document.title = state.metaTitle || "形試合（ベスト8→決勝採点）";

  const raw = document.getElementById("players").value.split(/\r?\n/).map(v=>v.trim()).filter(Boolean);
  if(raw.length < 1){ alert("1名以上入力してください"); return; }

  state.players = raw.map(name=>({ name, attendance:"-" }));
  buildRoundsToBest8();
  renderBase();
  render();
  closeFinal();
}
document.getElementById("startBtn").addEventListener("click", startTournament);

/* ===== 決勝（手動ボタン） ===== */
document.getElementById("finalBtn").addEventListener("click", ()=>{
  if(!state.rounds.length){ alert("先に開始してください"); return; }
  const last = state.rounds[state.rounds.length-1];
  const slots = [];
  last.forEach(m=>slots.push(m.players[0], m.players[1]));
  if(slots.length !== 8 || slots.some(p => !p)){
    alert("ベスト8枠が揃っていません（上の回戦で勝者を入力してください）");
    return;
  }
  state.best8 = slots.map(p=>{
    if(!p) return {name:"-", attendance:"-"};
    if(p.name === "-") return {name:"-", attendance:"-"};
    return {name:p.name, attendance:p.attendance || "-"};
  });
  initFinalFromBest8();
});

/* ===== 保存（送付用JSON + ローカル） ===== */
const APP_KIND = "kata";
const TEMP_KEY = "kata_app_state_v1_" + APP_KIND;

function getPayload(){
  return {
    v: 1,
    app: APP_KIND,
    state,
    courtList,
    selectedCourt,
    ui: {
      playersText: document.getElementById("players").value,
      metaTitle: document.getElementById("metaTitle").value,
      metaType: document.getElementById("metaType").value,
      metaStyle: document.getElementById("metaStyle").value,
      metaCategory: document.getElementById("metaCategory").value,
      courtCount: Number(document.getElementById("courtCountInput").value || courtList.length || 1)
    },
    updatedAt: new Date().toISOString()
  };
}

function downloadJson(data){
  const title = (data?.ui?.metaTitle || data?.state?.metaTitle || "kata").replace(/[\/:*?"<>|]/g, "_");
  const dt = new Date();
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const d = String(dt.getDate()).padStart(2,"0");
  const hh = String(dt.getHours()).padStart(2,"0");
  const mm = String(dt.getMinutes()).padStart(2,"0");
  const fileName = `${title}_${APP_KIND}_${y}${m}${d}_${hh}${mm}.json`;

  const blob = new Blob([JSON.stringify(data, null, 2)], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function restoreFromPayload(data){
  if(!data || !data.state) throw new Error("invalid");

  // meta
  document.getElementById("metaTitle").value = data.ui?.metaTitle ?? data.state.metaTitle ?? "";
  document.getElementById("metaType").value = data.ui?.metaType ?? data.state.metaType ?? "";
  document.getElementById("metaStyle").value = data.ui?.metaStyle ?? data.state.metaStyle ?? "";
  document.getElementById("metaCategory").value = data.ui?.metaCategory ?? data.state.metaCategory ?? "";
  document.title = (document.getElementById("metaTitle").value || "形試合（ベスト8→決勝採点）");

  // courts
  courtList = Array.isArray(data.courtList) ? data.courtList.slice() : ["-"];
  selectedCourt = data.selectedCourt ?? (courtList[0] ?? "-");
  document.getElementById("courtCountInput").value = String(Math.max(1, Math.min(8, courtList.length || 1)));
  buildCourtPalette();

  // players textarea
  const pt = data.ui?.playersText;
  if(typeof pt === "string") document.getElementById("players").value = pt;

  // state
  state = data.state;
  if(!state.players) state.players = [];
  if(!state.rounds) state.rounds = [];
  if(!state.best8) state.best8 = [];

  // redraw
  try{ closeFinal(); }catch(_){ }
  renderBase();
  render();
  return true;
}

function tempSave(){
  const payload = getPayload();
  try{ localStorage.setItem(TEMP_KEY, JSON.stringify(payload)); }catch(_){ }
  downloadJson(payload);
}

function finalSave(){
  const payload = getPayload();
  downloadJson(payload);
}

document.getElementById("saveBtn").addEventListener("click", (() => {
  let armed=false, t=null;
  return ()=>{
    const b = document.getElementById("saveBtn");
    if(!armed){
      armed=true; b.classList.add("armed");
      if(t) clearTimeout(t);
      t=setTimeout(()=>{ armed=false; b.classList.remove("armed"); }, 2500);
      return;
    }
    armed=false; b.classList.remove("armed");
    if(t) clearTimeout(t);
    tempSave();
  };
})());

document.getElementById("finalSaveBtn").addEventListener("click", finalSave);

// JSON読込
(function(){
  const btn = document.getElementById("loadBtn");
  const inp = document.getElementById("loadFile");
  if(btn && inp){
    btn.addEventListener("click", ()=>inp.click());
    inp.addEventListener("change", async () => {
      const f = inp.files && inp.files[0];
      if(!f) return;
      try{
        const txt = await f.text();
        const data = JSON.parse(txt);
        restoreFromPayload(data);
      }catch(e){
        alert("読込に失敗しました");
      }finally{
        inp.value = "";
      }
    });
  }
})();

// 起動時：この端末の一時保存があれば復元（任意）
(() => {
  try{
    const s = localStorage.getItem(TEMP_KEY);
    if(!s) return;
    const data = JSON.parse(s);
    restoreFromPayload(data);
  }catch(_){ }
})();

/* ===== 決勝UI ===== */
document.getElementById("finalCloseBtn").addEventListener("click", closeFinal);
document.getElementById("judgeCount").addEventListener("change", ()=>{
  if(!document.getElementById("finalArea").classList.contains("hidden")) initFinalFromBest8(true);
});
document.getElementById("basePoint").addEventListener("change", ()=>{
  if(!document.getElementById("finalArea").classList.contains("hidden")) buildFinalKeypad();
});

function closeFinal(){
  document.getElementById("finalArea").classList.add("hidden");
  finalPlayers = [];
  finalScoresByPlayer = [];
  finalManualTotal = [];
  finalSelectedPlayer = 0;
  finalSelectedJudge = 0;
  curInt = null;
  curDec = null;
  rankOverride = Array(8).fill(null);
  tiebreaks = [];
  document.getElementById("finalPlayersTbody").innerHTML = "";
  document.getElementById("judgeList").innerHTML = "";
  document.getElementById("intMain").innerHTML = "";
  document.getElementById("intSub").innerHTML = "";
  document.getElementById("decPad").innerHTML = "";
  document.getElementById("decBottomRow").innerHTML = "";
  document.getElementById("tbCards").innerHTML = "";
  document.getElementById("tbCards").classList.add("hidden");
  document.getElementById("tbToggleBtn").textContent = "表示";
  resetRanks();
}

function initFinalFromBest8(keepScores=false){
  judgeNum = Number(document.getElementById("judgeCount").value || 7);
  const oldScores = keepScores ? finalScoresByPlayer : null;
  const oldManual = keepScores ? finalManualTotal : null;

  finalPlayers = state.best8.map(p=>({ name:p.name, attendance:p.attendance || "-" }));
  finalScoresByPlayer = finalPlayers.map((_, i)=>{
    if(oldScores && oldScores[i]){
      const arr = oldScores[i].slice(0, judgeNum);
      while(arr.length < judgeNum) arr.push(null);
      return arr;
    }
    return Array(judgeNum).fill(null);
  });
  finalManualTotal = finalPlayers.map((_, i)=> (oldManual && oldManual[i]!=null ? oldManual[i] : null));

  finalSelectedPlayer = 0;
  finalSelectedJudge = 0;

  const base = Number(document.getElementById("basePoint").value || 7);
  curInt = base;
  curDec = null;

  rankOverride = Array(8).fill(null);

  initTieBreakCards();

  document.getElementById("finalArea").classList.remove("hidden");
  buildFinalPlayersTable();
  buildFinalJudgeList();
  buildFinalKeypad();
  resetRanks();
  refreshFinalUI();
}

function buildFinalPlayersTable(){
  const tb = document.getElementById("finalPlayersTbody");
  tb.innerHTML = "";
  finalPlayers.forEach((p, idx)=>{
    const tr = document.createElement("tr");
    tr.dataset.idx = String(idx);

    const tdName = document.createElement("td");
    const btn = document.createElement("button");
    btn.className = "finalRowBtn";
    btn.type = "button";
    btn.textContent = p.name;
    btn.onclick = ()=>{ finalSelectedPlayer = idx; refreshFinalUI(); };
    tdName.appendChild(btn);

    const tdSum = document.createElement("td");
    tdSum.className = "scoreCell";
    tdSum.id = `p${idx}_sum`;
    tdSum.style.cursor = "pointer";
    tdSum.onclick = ()=> editManualTotal(idx);

    const tdPlusMin = document.createElement("td"); tdPlusMin.className = "miniCell"; tdPlusMin.id = `p${idx}_pmin`;
    const tdPlusMax = document.createElement("td"); tdPlusMax.className = "miniCell"; tdPlusMax.id = `p${idx}_pmax`;

    tdSum.textContent = "--";
    tdPlusMin.textContent = "--";
    tdPlusMax.textContent = "--";

    tr.appendChild(tdName);
    tr.appendChild(tdSum);
    tr.appendChild(tdPlusMin);
    tr.appendChild(tdPlusMax);
    tb.appendChild(tr);
  });
}

function editManualTotal(idx){
  const cur = finalManualTotal[idx];
  const v = prompt("合計点（手入力）を入力。\n空欄で解除。", cur==null ? "" : String(cur));
  if(v === null) return;
  const t = String(v).trim();
  if(t === ""){ finalManualTotal[idx] = null; refreshFinalUI(); return; }
  const num = Number(t);
  if(!Number.isFinite(num)){ alert("数値を入力してください"); return; }
  finalManualTotal[idx] = num;
  refreshFinalUI();
}

function buildFinalJudgeList(){
  const list = document.getElementById("judgeList");
  list.innerHTML = "";
  for(let j=0;j<judgeNum;j++){
    const row = document.createElement("div");
    row.className = "jRow";
    row.dataset.j = String(j);

    const jb = document.createElement("button");
    jb.type = "button";
    jb.className = "jBtn";
    jb.textContent = (j===0) ? "主審" : `副審${j}`;
    jb.onclick = ()=>{ finalSelectedJudge = j; refreshFinalUI(); };

    const sc = document.createElement("div");
    sc.className = "jScore";
    sc.id = `jScore_${j}`;
    sc.textContent = "--.--";

    row.appendChild(jb);
    row.appendChild(sc);
    list.appendChild(row);
  }
}

function buildFinalKeypad(){
  const base = Number(document.getElementById("basePoint").value || 7);
  const intMain = document.getElementById("intMain");
  const intSub = document.getElementById("intSub");
  const decPad = document.getElementById("decPad");
  const decBottom = document.getElementById("decBottomRow");

  intMain.innerHTML = "";
  intSub.innerHTML = "";
  decPad.innerHTML = "";
  decBottom.innerHTML = "";

  /* 一の位： [6][7][8] みたいに3つ同幅 */
  [base-1, base, base+1].forEach(v=>{
    const b = document.createElement("button");
    b.type="button";
    b.className="kBtn";
    b.dataset.v = String(v);
    b.textContent = String(v);
    b.onclick = ()=>{ curInt = v; highlightKey(); };
    intMain.appendChild(b);
  });

  /* 一の位予備： [5][9] */
  [base-2, base+2].forEach(v=>{
    const b = document.createElement("button");
    b.type="button";
    b.className="kBtn";
    b.dataset.v = String(v);
    b.textContent = String(v);
    b.onclick = ()=>{ curInt = v; highlightKey(); };
    intSub.appendChild(b);
  });

  /* 少数桁： [7][8][9] [4][5][6] [1][2][3] */
  const order = [7,8,9,4,5,6,1,2,3];
  order.forEach(v=>{
    const b = document.createElement("button");
    b.type="button";
    b.className="kBtn";
    b.dataset.v = String(v);
    b.textContent = String(v);
    b.onclick = ()=>{ curDec = v; highlightKey(); };
    decPad.appendChild(b);
  });

  /* 下段： [0] [次] を同じ行・同幅 */
  const b0 = document.createElement("button");
  b0.type="button";
  b0.className="kBtn";
  b0.dataset.v = "0";
  b0.textContent = "0";
  b0.onclick = ()=>{ curDec = 0; highlightKey(); };

  const next = document.createElement("button");
  next.id = "nextBtn";
  next.type = "button";
  next.className = "kBtn"; /* 依頼①：幅・高さ・角丸を揃える */
  next.textContent = "次";
  next.onclick = finalizeJudgeScore;

  decBottom.appendChild(b0);
  decBottom.appendChild(next);

  highlightKey();
}

function highlightKey(){
  document.querySelectorAll("#intMain .kBtn, #intSub .kBtn").forEach(b=>{
    b.classList.toggle("active", Number(b.dataset.v) === curInt);
  });
  document.querySelectorAll("#decPad .kBtn, #decBottomRow .kBtn").forEach(b=>{
    b.classList.toggle("active", Number(b.dataset.v) === curDec);
  });
}

function formatScore(v){ return (v==null) ? "--.--" : Number(v).toFixed(2); }

function calcPlayerAuto(arr){
  if(!arr || arr.some(v => v==null)) return {sum:null, plusMin:null, plusMax:null};
  const nums = arr.slice().map(Number);
  const min = Math.min(...nums);
  const max = Math.max(...nums);
  const sumAll = nums.reduce((a,b)=>a+b,0);
  const sum = sumAll - min - max;
  return { sum, plusMin: sum + min, plusMax: sum + min + max };
}
function getPlayerSum(i){
  if(finalManualTotal[i] != null) return {sum: finalManualTotal[i], manual:true};
  const d = calcPlayerAuto(finalScoresByPlayer[i]);
  return {sum:d.sum, manual:false};
}

function resetRanks(){
  for(let i=1;i<=8;i++){
    const el = document.getElementById("rank"+i);
    if(!el) continue;
    el.textContent = i + "位：--";
    el.classList.remove("seed-rank");
  }
}

function computeFinalRanks(){
  const baseItems = finalPlayers.map((p, i)=>{
    const d = getPlayerSum(i);
    const invalid = (!p || !p.name || p.name === "-" || p.name === "seed");
    return { name: p ? p.name : "-", score: (invalid ? null : d.sum) };
  });

  baseItems.sort((a,b)=>{
    if(a.score==null && b.score==null) return 0;
    if(a.score==null) return 1;
    if(b.score==null) return -1;
    if(b.score !== a.score) return b.score - a.score;
    return String(a.name).localeCompare(String(b.name), "ja");
  });

  const finalRankNames = Array(8).fill(null);
  const used = new Set();

  for(let r=0;r<8;r++){
    const ov = rankOverride[r];
    if(ov && ov.name){
      finalRankNames[r] = ov.name;
      used.add(ov.name);
    }
  }

  let k = 0;
  for(let r=0;r<8;r++){
    if(finalRankNames[r]) continue;
    while(k < baseItems.length && (baseItems[k].score==null || used.has(baseItems[k].name))) k++;
    if(k >= baseItems.length){ finalRankNames[r] = null; continue; }
    finalRankNames[r] = baseItems[k].name;
    used.add(baseItems[k].name);
    k++;
  }

  for(let r=1;r<=8;r++){
    const el = document.getElementById("rank"+r);
    const nm = finalRankNames[r-1];
    if(!el) continue;
    if(!nm){
      el.textContent = r + "位：--";
      el.classList.add("seed-rank");
    }else{
      el.textContent = r + "位：" + nm;
      el.classList.remove("seed-rank");
    }
  }
}

function refreshFinalUI(){
  document.querySelectorAll("#finalPlayersTbody tr").forEach(tr=>{
    tr.classList.toggle("trSelected", Number(tr.dataset.idx) === finalSelectedPlayer);
  });

  const arr = finalScoresByPlayer[finalSelectedPlayer] || [];
  document.querySelectorAll("#judgeList .jRow").forEach(row=>{
    const j = Number(row.dataset.j);
    row.classList.toggle("jActive", j === finalSelectedJudge);
    const el = document.getElementById(`jScore_${j}`);
    if(el) el.textContent = formatScore(arr[j]);
  });

  highlightKey();

  finalPlayers.forEach((_, i)=>{
    const d = getPlayerSum(i);
    const elSum = document.getElementById(`p${i}_sum`);
    const elPmin = document.getElementById(`p${i}_pmin`);
    const elPmax = document.getElementById(`p${i}_pmax`);
    if(!elSum || !elPmin || !elPmax) return;

    if(d.sum==null){
      elSum.textContent = "--";
      elPmin.textContent = "--";
      elPmax.textContent = "--";
    }else{
      if(d.manual){
        elSum.innerHTML = `${Number(d.sum).toFixed(2)}<span class="manualTag">M</span>`;
        elPmin.textContent = "--";
        elPmax.textContent = "--";
      }else{
        const auto = calcPlayerAuto(finalScoresByPlayer[i]);
        elSum.textContent = auto.sum==null ? "--" : auto.sum.toFixed(2);
        elPmin.textContent = auto.plusMin==null ? "--" : auto.plusMin.toFixed(2);
        elPmax.textContent = auto.plusMax==null ? "--" : auto.plusMax.toFixed(2);
      }
    }
  });

  refreshTieBreakUI();
  computeFinalRanks();
}

function finalizeJudgeScore(){
  if(curInt==null) curInt = Number(document.getElementById("basePoint").value || 7);
  if(curDec==null) return;

  const v = Number(`${curInt}.${curDec}`);
  finalScoresByPlayer[finalSelectedPlayer][finalSelectedJudge] = v;

  finalSelectedJudge = (finalSelectedJudge + 1) % judgeNum;
  curDec = null;
  refreshFinalUI();
}

/* ===== 再試合（最大4） ===== */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function playerOptionsHTML(){
  const opts = ['<option value="">（選択）</option>'];
  for(let i=0;i<finalPlayers.length;i++){
    opts.push(`<option value="${i}">${escapeHtml(finalPlayers[i].name)}</option>`);
  }
  return opts.join("");
}
function parseMaybeNumber(v){
  const t = String(v||"").trim();
  if(t==="") return null;
  const n = Number(t);
  return Number.isFinite(n) ? n : null;
}
function initTieBreakCards(){
  tiebreaks = [];
  for(let i=0;i<4;i++){
    tiebreaks.push({
      targetRank: 3,
      participants: [{pid:null,score:null},{pid:null,score:null},{pid:null,score:null},{pid:null,score:null}],
      order: [null,null,null,null],
      applied:false
    });
  }
  renderTieBreakCards();
}

function renderTieBreakCards(){
  const host = document.getElementById("tbCards");
  host.innerHTML = "";
  const opts = playerOptionsHTML();

  tiebreaks.forEach((tb, idx)=>{
    const card = document.createElement("div");
    card.className = "tbCard";
    card.id = `tb_${idx}`;

    const head = document.createElement("div");
    head.className = "tbHead";
    head.innerHTML = `
      <b>再試合${idx+1}</b>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <span style="font-weight:900;">対象順位</span>
        <select id="tbRank_${idx}" style="border:1px solid #777;border-radius:10px;padding:10px;font-size:14px;">
          ${[1,2,3,4,5,6,7,8].map(r=>`<option value="${r}">${r}位決定</option>`).join("")}
        </select>
      </div>
    `;
    card.appendChild(head);

    for(let k=0;k<4;k++){
      const row = document.createElement("div");
      row.className = "tbRow";
      row.innerHTML = `
        <select id="tbP_${idx}_${k}">${opts}</select>
        <input id="tbS_${idx}_${k}" type="text" inputmode="decimal" placeholder="点(任意)">
      `;
      card.appendChild(row);
    }

    const btns = document.createElement("div");
    btns.className = "tbBtns";
    btns.innerHTML = `
      <button id="tbSort_${idx}" type="button">点順</button>
      <button id="tbApply_${idx}" type="button">順位表へ反映</button>
      <button id="tbClear_${idx}" type="button">解除</button>
    `;
    card.appendChild(btns);

    const order = document.createElement("div");
    order.className = "tbOrder";
    order.innerHTML = `
      <select id="tbO_${idx}_0">${opts}</select>
      <select id="tbO_${idx}_1">${opts}</select>
      <select id="tbO_${idx}_2">${opts}</select>
      <select id="tbO_${idx}_3">${opts}</select>
    `;
    card.appendChild(order);

    const note = document.createElement("div");
    note.className = "smallNote";
    note.textContent = "上：参加選手と点（任意）／下：結果（手動確定）。反映は対象順位から最大4枠。";
    card.appendChild(note);

    host.appendChild(card);

    const rankSel = card.querySelector(`#tbRank_${idx}`);
    rankSel.value = String(tb.targetRank);
    rankSel.onchange = ()=>{ tb.targetRank = Number(rankSel.value); };

    for(let k=0;k<4;k++){
      const ps = card.querySelector(`#tbP_${idx}_${k}`);
      const ss = card.querySelector(`#tbS_${idx}_${k}`);
      ps.value = tb.participants[k].pid==null ? "" : String(tb.participants[k].pid);
      ss.value = tb.participants[k].score==null ? "" : String(tb.participants[k].score);
      ps.onchange = ()=>{ tb.participants[k].pid = ps.value==="" ? null : Number(ps.value); };
      ss.onchange = ()=>{ tb.participants[k].score = parseMaybeNumber(ss.value); refreshFinalUI(); };
    }

    for(let o=0;o<4;o++){
      const os = card.querySelector(`#tbO_${idx}_${o}`);
      os.value = tb.order[o]==null ? "" : String(tb.order[o]);
      os.onchange = ()=>{ tb.order[o] = os.value==="" ? null : Number(os.value); };
    }

    card.querySelector(`#tbSort_${idx}`).onclick = ()=>{
      sortTieBreak(tb);
      refreshTieBreakUI();
      computeFinalRanks();
    };
    card.querySelector(`#tbApply_${idx}`).onclick = ()=>{
      applyTieBreak(tb);
      refreshTieBreakUI();
      computeFinalRanks();
    };
    card.querySelector(`#tbClear_${idx}`).onclick = ()=>{
      clearTieBreak(tb);
      refreshTieBreakUI();
      computeFinalRanks();
    };
  });
}

function sortTieBreak(tb){
  const entries = [];
  for(let i=0;i<4;i++){
    const pid = tb.participants[i].pid;
    if(pid==null) continue;
    const explicit = tb.participants[i].score;
    const sc = (explicit!=null) ? explicit : getPlayerSum(pid).sum;
    if(sc==null) continue;
    entries.push({pid, sc});
  }
  entries.sort((a,b)=> b.sc - a.sc);
  tb.order = [null,null,null,null];
  for(let i=0;i<Math.min(4, entries.length);i++) tb.order[i] = entries[i].pid;
}

function applyTieBreak(tb){
  const start = Math.max(1, Math.min(8, Number(tb.targetRank||3))) - 1;
  const filled = tb.order.filter(v=>v!=null);
  if(filled.length < 2){
    alert("結果（手動確定）を2名以上選択してください（下のセレクト）。");
    return;
  }
  for(let i=0;i<4;i++){
    const pid = tb.order[i];
    if(pid==null) continue;
    const nm = finalPlayers[pid]?.name;
    if(!nm) continue;
    if(start + i < 8) rankOverride[start + i] = {name:nm};
  }
  tb.applied = true;
}

function clearTieBreak(tb){
  const start = Math.max(1, Math.min(8, Number(tb.targetRank||3))) - 1;
  for(let i=0;i<4;i++){
    if(start + i < 8) rankOverride[start + i] = null;
  }
  tb.applied = false;
}

function refreshTieBreakUI(){
  tiebreaks.forEach((tb, idx)=>{
    const card = document.getElementById(`tb_${idx}`);
    if(!card) return;
    for(let o=0;o<4;o++){
      const os = card.querySelector(`#tbO_${idx}_${o}`);
      if(os) os.value = tb.order[o]==null ? "" : String(tb.order[o]);
    }
  });
}

/* 再試合 表示トグル */
document.getElementById("tbToggleBtn").addEventListener("click", ()=>{
  const box = document.getElementById("tbCards");
  const btn = document.getElementById("tbToggleBtn");
  const isHidden = box.classList.contains("hidden");
  if(isHidden){
    box.classList.remove("hidden");
    btn.textContent = "非表示";
  }else{
    box.classList.add("hidden");
    btn.textContent = "表示";
  }
});

/* init */
applyCourtCount();      /* 初期1コート表示 */
buildCourtPalette();
resetRanks();


/* ===== Vercel同期（カテゴリ別JSON） ===== */
const SAVE_TOKEN_KEY = "KARATE_SAVE_TOKEN";
const LAST_CAT_KEY = "KARATE_LAST_CAT_" + (typeof APP_KIND !== "undefined" ? APP_KIND : "app");
const CATEGORY_LIST = [{"cat": "team_e34_m", "label": "団体戦 小学３・４年男子の部", "style": "団体戦"}, {"cat": "team_e34_f", "label": "団体戦 小学３・４年女子の部", "style": "団体戦"}, {"cat": "team_e56_m", "label": "団体戦 小学５・６年男子の部", "style": "団体戦"}, {"cat": "team_e56_f", "label": "団体戦 小学５・６年女子の部", "style": "団体戦"}, {"cat": "team_jhs_m", "label": "団体戦 中学生男子の部", "style": "団体戦"}, {"cat": "team_jhs_f", "label": "団体戦 中学生女子の部", "style": "団体戦"}, {"cat": "team_hs_m", "label": "団体戦 高校生男子の部", "style": "団体戦"}, {"cat": "team_hs_f", "label": "団体戦 高校生女子の部", "style": "団体戦"}, {"cat": "team_adult_m", "label": "団体戦 一般男子の部", "style": "団体戦"}, {"cat": "team_adult_f", "label": "団体戦 一般女子の部", "style": "団体戦"}, {"cat": "ind_e3_m", "label": "個人戦 小学３年男子の部", "style": "個人戦"}, {"cat": "ind_e3_f", "label": "個人戦 小学３年女子の部", "style": "個人戦"}, {"cat": "ind_e4_m", "label": "個人戦 小学４年男子の部", "style": "個人戦"}, {"cat": "ind_e4_f", "label": "個人戦 小学４年女子の部", "style": "個人戦"}, {"cat": "ind_e5_m", "label": "個人戦 小学５年男子の部", "style": "個人戦"}, {"cat": "ind_e5_f", "label": "個人戦 小学５年女子の部", "style": "個人戦"}, {"cat": "ind_e6_m", "label": "個人戦 小学６年男子の部", "style": "個人戦"}, {"cat": "ind_e6_f", "label": "個人戦 小学６年女子の部", "style": "個人戦"}, {"cat": "ind_j1_m", "label": "個人戦 中学１年男子の部", "style": "個人戦"}, {"cat": "ind_j1_f", "label": "個人戦 中学１年女子の部", "style": "個人戦"}, {"cat": "ind_j2_m", "label": "個人戦 中学２年男子の部", "style": "個人戦"}, {"cat": "ind_j2_f", "label": "個人戦 中学２年女子の部", "style": "個人戦"}, {"cat": "ind_j3_m", "label": "個人戦 中学３年男子の部", "style": "個人戦"}, {"cat": "ind_j3_f", "label": "個人戦 中学３年女子の部", "style": "個人戦"}, {"cat": "ind_hs_m", "label": "個人戦 高校生男子の部", "style": "個人戦"}, {"cat": "ind_hs_f", "label": "個人戦 高校生女子の部", "style": "個人戦"}, {"cat": "ind_adult_m", "label": "個人戦 一般男子の部", "style": "個人戦"}, {"cat": "ind_adult_f", "label": "個人戦 一般女子の部", "style": "個人戦"}];

function qsParam(name){
  try{ return new URLSearchParams(location.search).get(name); }catch(_){ return null; }
}

function getKind(){
  return (typeof APP_KIND !== "undefined" && APP_KIND) ? APP_KIND : "kata";
}

function buildCatSelect(){
  const sel = document.getElementById("catSelect");
  if(!sel) return;
  sel.innerHTML = "";
  CATEGORY_LIST.forEach(it=>{
    const opt=document.createElement("option");
    opt.value=it.cat;
    opt.textContent=it.label;
    sel.appendChild(opt);
  });

  const param = qsParam("cat");
  const saved = (()=>{ try{return localStorage.getItem(LAST_CAT_KEY);}catch(_){return null;} })();
  const initial = param || saved || (CATEGORY_LIST[0]?.cat || "");
  sel.value = initial;

  sel.addEventListener("change", ()=>{
    try{ localStorage.setItem(LAST_CAT_KEY, sel.value); }catch(_){ }
    const it = CATEGORY_LIST.find(x=>x.cat===sel.value);
    if(it){
      try{ document.getElementById("metaStyle").value = it.style || ""; }catch(_){ }
      try{ document.getElementById("metaCategory").value = it.label.replace(/^団体戦\s+|^個人戦\s+/, ""); }catch(_){ }
    }
  });

  // 1回反映
  sel.dispatchEvent(new Event("change"));
}

function getCurrentCat(){
  const sel=document.getElementById("catSelect");
  return (sel && sel.value) ? sel.value : (qsParam("cat") || "");
}

function setLastSyncText(msg){
  const el=document.getElementById("lastSync");
  if(el) el.textContent = msg || "";
}

function nowHHMMSS(){
  const d=new Date();
  const hh=String(d.getHours()).padStart(2,"0");
  const mm=String(d.getMinutes()).padStart(2,"0");
  const ss=String(d.getSeconds()).padStart(2,"0");
  return `${hh}:${mm}:${ss}`;
}

async function serverLoad(){
  const cat=getCurrentCat();
  if(!cat){ alert("カテゴリが未選択です"); return; }
  const kind=getKind();
  setLastSyncText("読込中…");
  try{
    const res = await fetch(`/api/load?kind=${encodeURIComponent(kind)}&cat=${encodeURIComponent(cat)}`, { cache:"no-store" });
    if(res.status===404){
      setLastSyncText(`未保存（${nowHHMMSS()}）`);
      return;
    }
    if(!res.ok){
      setLastSyncText(`読込失敗（${res.status}）`);
      return;
    }
    const data = await res.json();
    restoreFromPayload(data);
    setLastSyncText(`読込 OK（${nowHHMMSS()}）`);
  }catch(e){
    setLastSyncText(`読込失敗（${nowHHMMSS()}）`);
  }
}

function getSaveToken(){
  let t="";
  try{ t = localStorage.getItem(SAVE_TOKEN_KEY) || ""; }catch(_){ }
  if(!t){
    t = prompt("サーバー保存キー（初回のみ）\n※Vercelの環境変数 SAVE_TOKEN と一致させてください");
    if(!t) return "";
    try{ localStorage.setItem(SAVE_TOKEN_KEY, t); }catch(_){ }
  }
  return t;
}

async function serverSave(){
  const cat=getCurrentCat();
  if(!cat){ alert("カテゴリが未選択です"); return; }
  const kind=getKind();
  const token=getSaveToken();
  if(!token) return;

  const who = (document.getElementById("whoInput")?.value || "").trim();
  const payload = getPayload();
  // UI情報を追記（あっても無視されてもOK）
  payload.ui = payload.ui || {};
  payload.ui.updatedAt = new Date().toISOString();
  if(who) payload.ui.updatedBy = who;

  setLastSyncText("保存中…");
  try{
    const res = await fetch(`/api/save?kind=${encodeURIComponent(kind)}&cat=${encodeURIComponent(cat)}`, {
      method:"POST",
      headers:{"content-type":"application/json","x-save-token": token},
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      setLastSyncText(`保存失敗（${res.status}）`);
      alert("サーバー保存に失敗しました（保存キーやVercel設定を確認）");
      return;
    }
    setLastSyncText(`保存 OK（${nowHHMMSS()}）`);
  }catch(e){
    setLastSyncText(`保存失敗（${nowHHMMSS()}）`);
    alert("サーバー保存に失敗しました");
  }
}

function setViewerMode(enable){
  const vRow = document.getElementById("viewerRow");
  const sRow = document.getElementById("syncRow");
  if(vRow) vRow.style.display = enable ? "flex" : "none";
  if(sRow) sRow.style.display = enable ? "none" : "flex";

  const disableIds = ["startBtn","saveBtn","tempSaveBtn","finalSaveBtn","players","courtCountInput","setCourtCountBtn","metaTitle","metaStyle","metaType","metaCategory"]; 
  disableIds.forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    if(el.tagName==="TEXTAREA" || el.tagName==="INPUT") el.readOnly = enable;
    if(el.tagName==="BUTTON") el.disabled = enable;
  });

  // トーナメント内の操作を無効化（描画は維持）
  const wrapper=document.getElementById("wrapper");
  if(wrapper){
    wrapper.querySelectorAll("button").forEach(b=>{
      // viewer用ボタンは除外
      if(b.id==="refreshBtn") return;
      b.disabled = enable;
    });
  }
}

let _autoTimer=null;
function setupViewerAutoRefresh(){
  const tgl=document.getElementById("autoRefreshToggle");
  const sec=document.getElementById("autoRefreshSec");
  const refresh=document.getElementById("refreshBtn");

  if(refresh) refresh.addEventListener("click", serverLoad);

  function clear(){ if(_autoTimer){ clearInterval(_autoTimer); _autoTimer=null; } }
  function start(){
    clear();
    const s = Math.max(10, Math.min(600, Number(sec?.value || 90)));
    _autoTimer=setInterval(serverLoad, s*1000);
  }

  if(tgl){
    tgl.addEventListener("change", ()=>{ tgl.checked ? start() : clear(); });
  }
  if(sec){
    sec.addEventListener("change", ()=>{ if(tgl && tgl.checked) start(); });
  }
}

(function initVercelSync(){
  buildCatSelect();

  const loadBtn=document.getElementById("srvLoadBtn");
  const saveBtn=document.getElementById("srvSaveBtn");
  if(loadBtn) loadBtn.addEventListener("click", serverLoad);
  if(saveBtn) saveBtn.addEventListener("click", serverSave);

  const isViewer = true;
  setViewerMode(true);
setupViewerAutoRefresh();

  // viewerモード or autoload=1 のときは最初に読込
  const autoload = true;
  if(autoload){
    setTimeout(serverLoad, 150);
  }
})();

</script>
</body>
</html>
